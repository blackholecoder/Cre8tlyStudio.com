<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://themessyattic.com">
    <meta property="og:title" content="The Messy Attic | Where writers grow together">
<meta property="og:description" content="The Messy Attic is a supportive writing community where writers come together to share work, encourage one another, and grow through honest feedback and connection.">

    <meta property="og:image" content="https://themessyattic.com/themessyattic-og.jpg">
    <meta property="og:image:secure_url" content="https://themessyattic.com/themessyattic-og.jpg">
    <meta property="og:image:type" content="image/jpeg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="The Messy Attic | Where writers grow together">


    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EW7LYCFX9J"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-EW7LYCFX9J');
    </script>

    <!-- Extra Meta -->
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="The Messy Attic is a supportive writing community where writers come together to share work, encourage one another, and grow through honest feedback and connection.">
    <title>The Messy Attic | Where writers grow together</title>
    <link rel="icon" href="/favicon.ico">
<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="icon" type="image/svg+xml" href="/themessyattic-logo.svg">
    <script type="module" crossorigin src="/assets/index-e252f84c.js"></script>
    <link rel="stylesheet" href="/assets/index-c569115d.css">
  </head>
  <body>
    <div id="root"></div>

   

  <script>
    

 window.addEventListener("scroll", () => {
  document.hiddenByScrolling = true;
  setTimeout(() => {
    document.hiddenByScrolling = false;
  }, 500);
});

["resize", "orientationchange"].forEach(evt => {
  window.addEventListener(evt, () => {
    document.hiddenDuringUI = true;
    setTimeout(() => {
      document.hiddenDuringUI = false;
    }, 800);
  });
});

(function () {

  if (localStorage.getItem("accessToken")) return; 



  let exitAllowed = false;
setTimeout(() => (exitAllowed = true), 1500);

  /* -----------------------------
      Track UTM + device + browser
  ------------------------------ */
  const urlParams = new URLSearchParams(window.location.search);
  const utms = {};
  ["utm_source","utm_medium","utm_campaign","utm_term","utm_content","fbclid","ttclid"].forEach(k=>{
    if (urlParams.has(k)) utms[k] = urlParams.get(k);
  });

  function getDeviceType() {
    const ua = navigator.userAgent.toLowerCase();
    if (/iphone|ipad|ipod/.test(ua)) return "iOS";
    if (/android/.test(ua)) return "Android";
    if (/windows/.test(ua)) return "Windows";
    if (/macintosh/.test(ua)) return "Mac";
    if (/linux/.test(ua)) return "Linux";
    return "Unknown";
  }

  function getBrowser() {
    const ua = navigator.userAgent;
    if (ua.includes("Chrome") && !ua.includes("Edg")) return "Chrome";
    if (ua.includes("Safari") && !ua.includes("Chrome")) return "Safari";
    if (ua.includes("Firefox")) return "Firefox";
    if (ua.includes("Edg")) return "Edge";
    return "Unknown";
  }

  const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;



  /* -----------------------------
       Scroll Depth Tracking
  ------------------------------ */
  let maxScroll = 0;
  function trackScrollDepth() {
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    if (docHeight <= 0) return;
    const pct = Math.round((scrollTop / docHeight) * 100);
    if (pct > maxScroll) maxScroll = pct;
  }
  window.addEventListener("scroll", trackScrollDepth);



  /* -----------------------------
       Click Tracking
  ------------------------------ */
  const clickEvents = [];
  document.addEventListener("click", (e) => {
    const t = e.target;
    clickEvents.push({
      tag: t.tagName,
      text: (t.innerText || "").substring(0, 80),
      classes: t.className || "",
      id: t.id || "",
      timestamp: Date.now()
    });
  });



  /* -----------------------------
      Time on Page
  ------------------------------ */
  const start = Date.now();
  function timeOnPage() {
    return Math.round((Date.now() - start) / 1000);
  }



  /* -----------------------------
      Send Initial Visit
  ------------------------------ */
  const payloadBase = {
    page: window.location.pathname,
    full_url: window.location.href,
    referrer: document.referrer || null,
    utm: utms,
    device_type: getDeviceType(),
    browser: getBrowser(),
    screen_width: window.innerWidth,
    screen_height: window.innerHeight,
    timezone,
    language: navigator.language || null
  };

  fetch("https://themessyattic.com/api/web-analytics/track-visitor", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payloadBase)
  })
    .then((res) => res.json())
    .then((data) => {
  if (data?.visitor_id) {
  sessionStorage.setItem("visitor_id", data.visitor_id);
  exitAllowed = true; // <-- THIS FIXES EVERYTHING
} 
})



  /* -----------------------------
      Exit Tracking
  ------------------------------ */
  function sendExitData() {
    const VISITOR_ID = sessionStorage.getItem("visitor_id");

    if (!VISITOR_ID) {
      console.warn("⚠ Exit blocked — visitor_id not ready.");
      return;
    }

    const exitPayload = {
      visitor_id: VISITOR_ID,
      page: window.location.pathname,
      max_scroll: maxScroll,
      time_on_page: timeOnPage(),
      clicks: clickEvents.slice(0, 50)
    };

    const blob = new Blob(
      [JSON.stringify(exitPayload)],
      { type: "application/json" }
    );

    navigator.sendBeacon(
      "https://themessyattic.com/api/web-analytics/track-exit",
      blob
    );
  }

window.addEventListener("beforeunload", () => {
  const id = sessionStorage.getItem("visitor_id");
  if (!exitAllowed || !id) return;
  sendExitData();
});

document.addEventListener("visibilitychange", () => {
  const id = sessionStorage.getItem("visitor_id");

  if (
    document.visibilityState === "hidden" &&
    exitAllowed &&           // <—
    id &&                    // <—
    !document.hiddenByScrolling &&
    !document.hiddenDuringUI &&
    performance.now() > 800  // extra safety
  ) {
    sendExitData();
  }
});




})();
</script>





    
  </body>
</html>
